<!DOCTYPE html>
<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <title>TV Valgstedsresultater</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #00407a;
        color: white;
        font-family: "Segoe UI", Roboto, Oxygen, Ubuntu, "Open Sans", sans-serif;
        width: 1920px;
        height: 1080px;
      }

      .container {
        width: 1920px;
        height: 1080px;
        position: relative;
        display: flex;
        flex-direction: column;
        z-index: 5;
      }

      .header {
        height: 140px;
        background-color: #003366;
        padding: 20px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 4px solid #0085c7;
        z-index: 20;
        position: relative;
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      .title-box {
        background-color: #0085c7;
        padding: 15px 30px;
        border-radius: 8px;
        margin-right: 20px;
      }

      h1 {
        margin: 0;
        font-size: 48px;
        font-weight: bold;
      }
      h2 {
        margin: 0;
        font-size: 36px;
        font-weight: bold;
      }
      .subtitle {
        font-size: 28px;
      }

      .content {
        flex: 1;
        padding: 30px 40px;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      .info-box {
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 15px 30px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
      }

      .footer {
        height: 80px;
        background-color: #002244;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 40px;
        font-size: 22px;
        z-index: 20;
        position: relative;
      }

      .opdateret {
        opacity: 0.8;
      }
      .nedtaelling {
        opacity: 0.8;
        font-size: 20px;
        margin-top: 4px;
        display: flex;
        align-items: center;
      }

      .update-icon {
        width: 16px;
        height: 16px;
        display: inline-block;
        margin-right: 8px;
        opacity: 0.5;
        transition: all 0.5s ease;
      }

      .update-icon.pulse {
        opacity: 1;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 64, 122, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 40px;
        z-index: 100;
      }

      .spinner {
        display: inline-block;
        width: 80px;
        height: 80px;
        margin-right: 20px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #fadeOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.7s ease-in-out;
        z-index: 90;
      }

      /* Data opdatering effekter */
      .update-flash {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        opacity: 0;
        pointer-events: none;
        z-index: 30;
        transition: opacity 0.7s ease-in-out;
      }

      /* Stedskift effekter */
      #transitionOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 80;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
      }

      .transition-content {
        font-size: 72px;
        font-weight: bold;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 30px 60px;
        border-radius: 20px;
        border: 4px solid #0085c7;
        transform: scale(0.8);
        opacity: 0;
        transition: all 0.8s ease-in-out;
      }

      .optalt-indikator {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 5px;
        margin-left: 10px;
        font-size: 18px;
        font-weight: normal;
        transition: background-color 0.3s;
      }

      .optalt-indikator.fuldt {
        background-color: #1eaa5c;
      }

      .optalt-indikator.delvist {
        background-color: #f0ad4e;
      }

      .optalt-indikator.minimalt {
        background-color: #d9534f;
      }

      .difference {
        display: inline-block;
        font-size: 0.85em;
        padding-left: 5px;
        transition: color 0.3s;
      }

      .difference.positive {
        color: #1eaa5c;
      }

      .difference.negative {
        color: #ff5555;
      }

      .difference.neutral {
        color: #aaa;
      }

      /* Valgstedsresultater styling */
      .parti-liste {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .parti {
        display: flex;
        align-items: center;
        height: 60px;
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInUp 0.5s ease-out forwards;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }

      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .parti-info {
        width: 400px;
        display: flex;
        align-items: center;
      }

      .parti-bogstav {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 30px;
        font-weight: bold;
        margin-right: 20px;
        text-transform: uppercase;
      }

      .parti-navn {
        font-size: 24px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .parti-procent {
        width: 200px;
        font-size: 26px;
        font-weight: bold;
        text-align: right;
        padding-right: 10px;
        transition: all 0.5s ease-in-out;
      }

      .parti-stemmer {
        width: 200px;
        font-size: 24px;
        text-align: right;
        padding-right: 10px;
        transition: all 0.5s ease-in-out;
      }

      .bar-container {
        flex: 1;
        height: 40px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        overflow: hidden;
      }

      .bar {
        height: 100%;
        transition: width 1s ease-out;
        min-width: 2px;
        border-radius: 20px;
      }

      /* Resultatsammenligning sektionen */
      .resultater-sammenligning {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        gap: 20px;
      }

      .resultater-col {
        flex: 1;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 15px;
      }

      .resultater-header {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 24px;
        font-weight: bold;
      }

      /* Animation for ændring af data */
      .parti-data-change {
        animation: highlight 1.5s ease-in-out;
      }

      @keyframes highlight {
        0% {
          background-color: rgba(255, 255, 255, 0);
        }
        50% {
          background-color: rgba(255, 255, 255, 0.2);
        }
        100% {
          background-color: rgba(255, 255, 255, 0);
        }
      }

      /* Video baggrund */
      .video-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        overflow: hidden;
      }

      .video-background video {
        position: absolute;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        z-index: -1;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        object-fit: cover;
      }

      /* Tilføj en overlayeffekt for bedre læsbarhed */
      .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(
          0,
          64,
          122,
          0.85
        ); /* Justér opacity efter behov */
        z-index: 2;
      }

      /* Stilarter for CasparCG-metadata */
      .meta {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- CasparCG metadata (ikke synligt) -->
    <div id="meta" class="meta"></div>

    <!-- Video baggrund -->
    <div class="video-background">
      <div class="video-overlay"></div>
      <video autoplay muted loop playsinline>
        <source
          src="https://assets.nord.bazo.dk/video/290922_fv_loop_v1.mp4"
          type="video/mp4"
        />
      </video>
    </div>

    <div class="container">
      <div id="loadingScreen" class="loading">
        <div class="spinner">⟳</div>
        Indlæser valgstedsresultater...
      </div>

      <div class="header">
        <div class="header-left">
          <div class="title-box"><h1>KV21</h1></div>
          <h2>Valgstedsresultater</h2>
        </div>
        <div class="header-right">
          <h2 id="valgstedNavn">Valgsted</h2>
          <span id="optaltIndikator" class="optalt-indikator fuldt"
            >Optalt</span
          >
        </div>
      </div>

      <div class="content">
        <div class="info-box">
          <div id="kommuneInfo" class="subtitle">Kommune: -</div>
          <div id="valgdeltagelse" class="subtitle">Valgdeltagelse: 0.0%</div>
        </div>

        <div id="partiListe" class="parti-liste">
          <!-- Partier indsættes her -->
        </div>
      </div>

      <div class="footer">
        <div id="stemmeInfo">0 stemmer afgivet</div>
        <div>
          <div id="opdateretTid" class="opdateret">
            Sidst opdateret: --:--:--
          </div>
          <div id="nedtaelling" class="nedtaelling">
            <svg
              class="update-icon"
              viewBox="0 0 24 24"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z"
              />
            </svg>
            Opdaterer om: 30 sek
          </div>
        </div>
      </div>

      <!-- Visuelle effekter for overgange -->
      <div id="fadeOverlay"></div>
      <div id="updateFlash" class="update-flash"></div>
      <div id="transitionOverlay">
        <div id="transitionContent" class="transition-content"></div>
      </div>
    </div>

    <script>
      // Partifarvemapping
      const partiFarver = {
        A: "#e4002b", // Socialdemokratiet
        B: "#0085c7", // Radikale Venstre
        C: "#00a95c", // Konservative
        D: "#f58220", // Nye Borgerlige
        E: "#0085ca", // Klaus Riskær
        F: "#d71440", // SF
        G: "#005221", // Veganerpartiet
        I: "#ffc20e", // Liberal Alliance
        K: "#004b87", // Kristendemokraterne
        L: "#2cac2a", // Lokallisterne (generisk)
        M: "#522d80", // Moderaterne
        O: "#e3006e", // Dansk Folkeparti
        P: "#099d84", // Stram Kurs
        Q: "#7bc143", // Frie Grønne
        V: "#1e1e1e", // Venstre
        Ø: "#c00", // Enhedslisten
        Å: "#6a0dad", // Alternativet
      };

      // Tilføj små bogstaver-varianter
      Object.keys(partiFarver).forEach(
        (k) => (partiFarver[k.toLowerCase()] = partiFarver[k])
      );

      // Hjælpefunktion til at hente farve for et partibogstav
      const farve = (bogstav) => partiFarver[bogstav] || "#888";

      // Hent kommune-id og valgsted-id fra URL-parameter
      const urlParams = new URLSearchParams(window.location.search);
      let kommuneId = urlParams.get("kommune") || "851";
      let valgstedId = urlParams.get("valgsted") || "85103";

      let lastData = null; // Gemmer tidligere data til sammenligning
      let lastUpdateTimestamp = null;
      let cacheKey = Date.now(); // For at undgå cache ved API-kald

      // Hjælpefunktion til at få fat i elementer
      const el = (id) => document.getElementById(id);

      /**
       * Formater tal med tusindtalsseparator
       */
      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }

      /**
       * Sammenligner to datasæt og returnerer en liste af ændringer
       */
      function findDataChanges(oldData, newData) {
        if (!oldData || !oldData.parties || !newData || !newData.parties)
          return [];

        const changes = [];

        // Map oldData partier for lettere opslag
        const oldParties = {};
        oldData.parties.forEach((party) => {
          oldParties[party.letter || party.abbreviation] = party;
        });

        // Tjek hver parti i nydata
        newData.parties.forEach((newParty) => {
          const letter = newParty.letter || newParty.abbreviation;
          const oldParty = oldParties[letter];

          if (oldParty) {
            // Tjek om procenter eller stemmer er ændret
            if (
              oldParty.votesPercentage !== newParty.votesPercentage ||
              oldParty.votes !== newParty.votes
            ) {
              changes.push({
                partyLetter: letter,
                percentChange:
                  oldParty.votesPercentage !== newParty.votesPercentage,
                votesChange: oldParty.votes !== newParty.votes,
              });
            }
          }
        });

        return changes;
      }

      /**
       * Hent valgstedsdata fra TV2's API
       */
      async function hentValgstedsdata(visLoadingScreen = true) {
        if (visLoadingScreen) {
          el("loadingScreen").style.display = "flex";
        }

        try {
          // Tilføj cache-buster parameter til API-kaldet
          const url = `https://election-api.services.tv2.dk/kv/kv21/results/${kommuneId}/${valgstedId}?_cb=${cacheKey}`;
          const res = await fetch(url);

          if (!res.ok) {
            throw new Error(
              `Server returnerede ${res.status}: ${res.statusText}`
            );
          }

          const data = await res.json();
          console.log("Valgstedsdata modtaget:", data);

          // Find ændringer hvis vi har tidligere data
          const changes = findDataChanges(lastData, data);

          // Gem som sidste data til næste sammenligning
          lastData = data;

          // Gem metadata til CasparCG hvis det bruges
          gemCasparCGMetadata(data);

          // Vis data på siden
          visValgstedsdata(data, changes, !visLoadingScreen);

          // Opdater cache-key til næste kald
          cacheKey = Date.now();
        } catch (err) {
          console.error("Fejl ved hentning af data:", err);
          el("valgstedNavn").textContent = "DATAFEJL";
          el("loadingScreen").innerHTML = `
            <div class="spinner">⟳</div>
            Fejl ved hentning af data: ${err.message}<br>
            Prøver igen om få sekunder...
          `;

          // Genindlæs siden om 10 sekunder ved fejl
          setTimeout(() => {
            location.reload();
          }, 10000);
        }
      }

      /**
       * Gem metadata i en skjult div til CasparCG
       */
      function gemCasparCGMetadata(data) {
        const meta = {
          kommuneId: kommuneId,
          valgstedId: valgstedId,
          kommuneNavn: data.communityName || "",
          valgstedNavn: data.pollingStationName || "",
          antalStemmer: data.result?.validVotes || 0,
          valgdeltagelse: data.result?.votesPercentage || 0,
          opdateret: data.lastUpdated || "",
        };

        el("meta").setAttribute("data-json", JSON.stringify(meta));
      }

      /**
       * Vis transitionseffekt ved sted-skift
       */
      function visTransition(tekst) {
        const transitionDiv = el("transitionOverlay");
        const contentEl = el("transitionContent");

        // Sæt tekst
        contentEl.textContent = tekst;

        // Vis overlay
        transitionDiv.style.opacity = "1";

        // Start animation
        setTimeout(() => {
          contentEl.style.opacity = "1";
          contentEl.style.transform = "scale(1)";
        }, 100);

        // Skjul efter animation
        setTimeout(() => {
          contentEl.style.opacity = "0";
          contentEl.style.transform = "scale(1.2)";

          setTimeout(() => {
            transitionDiv.style.opacity = "0";
            setTimeout(() => {
              contentEl.style.transform = "scale(0.8)";
            }, 700);
          }, 800);
        }, 2000);
      }

      /**
       * Vis data opdateringseffekt
       */
      function visDataUpdateEffect() {
        const updateFlash = el("updateFlash");
        updateFlash.style.opacity = "0.3";

        setTimeout(() => {
          updateFlash.style.opacity = "0";
        }, 700);
      }

      /**
       * Vis valgstedsdata på siden
       */
      function visValgstedsdata(data, changes = [], subtilOpdatering = false) {
        // Hvis det er en subtil opdatering, viser vi en visuel effekt
        if (subtilOpdatering) {
          visDataUpdateEffect();
        }

        // Kommune og valgsted info
        const kommuneNavn = data.communityName || "Ukendt kommune";
        const valgstedNavn = data.pollingStationName || "Ukendt valgsted";

        el("valgstedNavn").textContent = valgstedNavn;
        el("kommuneInfo").textContent = `Kommune: ${kommuneNavn}`;

        // Håndter optællingsindikator
        const optaltIndikator = el("optaltIndikator");
        optaltIndikator.textContent = "Optalt";
        optaltIndikator.className = "optalt-indikator fuldt";

        // Valgdeltagelse
        if (data.result && typeof data.result.votesPercentage === "number") {
          el(
            "valgdeltagelse"
          ).textContent = `Valgdeltagelse: ${data.result.votesPercentage.toFixed(
            1
          )}%`;
        } else {
          el("valgdeltagelse").textContent = "Valgdeltagelse: Afventer";
        }

        // Stemmeinfo
        const stemmeInfo = el("stemmeInfo");
        if (data.result) {
          const validVotes = data.result.validVotes || 0;
          const blankVotes = data.result.blankVotes || 0;
          const invalidVotes = data.result.invalidVotes || 0;
          const totalVotes = validVotes + blankVotes + invalidVotes;

          stemmeInfo.textContent = `${formatNumber(
            totalVotes
          )} stemmer afgivet (${formatNumber(
            validVotes
          )} gyldige, ${formatNumber(blankVotes)} blanke, ${formatNumber(
            invalidVotes
          )} ugyldige)`;
        } else {
          stemmeInfo.textContent = "0 stemmer afgivet";
        }

        // Hvis det er subtil opdatering, opdaterer vi kun værdierne uden at genopbygge listen
        if (subtilOpdatering && el("partiListe").children.length > 0) {
          opdaterPartiListe(data.parties, changes);
        } else {
          // Ellers genopbygger vi hele listen
          opretPartiListe(data.parties);
        }

        // Opdater tidsstempel
        if (data.lastUpdated) {
          const dato = new Date(data.lastUpdated);
          el(
            "opdateretTid"
          ).textContent = `Sidst opdateret: ${dato.toLocaleTimeString(
            "da-DK"
          )}`;
          lastUpdateTimestamp = data.lastUpdated;
        } else {
          el("opdateretTid").textContent = "";
        }

        // Skjul loading-skærm
        el("loadingScreen").style.display = "none";
      }

      /**
       * Opret hele partilisten på ny
       */
      function opretPartiListe(partier) {
        // Ryd partilisten
        const liste = el("partiListe");
        liste.innerHTML = "";

        // Hent partier, sorter efter stemmeprocent
        const visPartier = (partier || []).sort(
          (a, b) => b.votesPercentage - a.votesPercentage
        );

        // Opret elementer for hvert parti
        visPartier.forEach((parti, i) => {
          const kode = (parti.letter || parti.abbreviation || "").toUpperCase();
          const navn = parti.name || "Ukendt";
          const procent =
            typeof parti.votesPercentage === "number"
              ? parti.votesPercentage.toFixed(1)
              : "0.0";
          const stemmer = parti.votes || 0;
          const color = farve(kode);

          // Opret parti-element
          const elBox = document.createElement("div");
          elBox.className = "parti";
          elBox.dataset.letter = kode;

          // Sæt animationsforsinkelse
          elBox.style.animationDelay = `${i * 100}ms`;

          // Byg HTML
          elBox.innerHTML = `
          <div class="parti-info">
            <div class="parti-bogstav" style="background-color: ${color}">${kode}</div>
            <div class="parti-navn">${navn}</div>
          </div>
          <div class="parti-procent">
            ${procent}%
          </div>
          <div class="parti-stemmer">
            ${formatNumber(stemmer)} stemmer
          </div>
          <div class="bar-container">
            <div class="bar" style="width: 0%; background-color: ${color}"></div>
          </div>
        `;

          // Tilføj til DOM
          liste.appendChild(elBox);

          // Animer bjælken efter en kort forsinkelse
          setTimeout(() => {
            const barEl = elBox.querySelector(".bar");
            barEl.style.width = `${Math.min(100, parseFloat(procent) * 2)}%`;
          }, 100);
        });
      }

      /**
       * Opdater eksisterende partiliste ved at ændre værdierne og animere ændrede værdier
       */
      function opdaterPartiListe(partier, changes) {
        // Find alle eksisterende parti-elementer
        const partiElements = document.querySelectorAll(".parti");
        if (!partiElements.length) return;

        // Sorter partier efter stemmeprocent
        const sortedPartier = (partier || []).sort(
          (a, b) => b.votesPercentage - a.votesPercentage
        );

        // Opdater hvert parti-element
        partiElements.forEach((partiElement, index) => {
          if (index >= sortedPartier.length) return;

          const parti = sortedPartier[index];
          const partiLetter = partiElement.dataset.letter;

          // Find procent og stemmer elementer
          const procentElement = partiElement.querySelector(".parti-procent");
          const stemmerElement = partiElement.querySelector(".parti-stemmer");
          const barElement = partiElement.querySelector(".bar");

          if (!procentElement || !stemmerElement || !barElement) return;

          // Tjek om dette parti har ændringer
          const hasChanges = changes.find((c) => c.partyLetter === partiLetter);

          // Opdater værdierne
          const procent =
            typeof parti.votesPercentage === "number"
              ? parti.votesPercentage.toFixed(1)
              : "0.0";

          const stemmer = parti.votes || 0;

          // Opdater procent
          procentElement.textContent = `${procent}%`;

          // Opdater stemmer
          stemmerElement.textContent = `${formatNumber(stemmer)} stemmer`;

          // Opdater søjle
          barElement.style.width = `${Math.min(100, parseFloat(procent) * 2)}%`;

          // Tilføj highlight animation til ændrede elementer
          if (hasChanges) {
            if (hasChanges.percentChange) {
              procentElement.classList.add("parti-data-change");
              setTimeout(() => {
                procentElement.classList.remove("parti-data-change");
              }, 1500);
            }

            if (hasChanges.votesChange) {
              stemmerElement.classList.add("parti-data-change");
              setTimeout(() => {
                stemmerElement.classList.remove("parti-data-change");
              }, 1500);
            }
          }
        });
      }

      /**
       * Lyt efter postMessage events fra kontrolpanelet
       */
      window.addEventListener("message", function (event) {
        // Tjek om beskeden kommer fra en betroet kilde (kan tilpasses)
        // if (event.origin !== "http://din-betroede-domæne.dk") return;

        if (event.data?.action === "skiftValgsted") {
          // Få fat i valgsteds-data til transition
          const nyKommuneId = event.data.kommuneId;
          const nyValgstedId = event.data.valgstedId;
          const valgstedNavn = event.data.valgstedNavn || "Nyt valgsted";

          // Vis transitions animation
          visTransition(valgstedNavn);

          // Fade-out effekt før vi skifter valgsted
          const fadeEl = document.getElementById("fadeOverlay");
          fadeEl.style.opacity = "1"; // Fade out

          // Skift valgsted efter fade-out
          setTimeout(() => {
            kommuneId = nyKommuneId;
            valgstedId = nyValgstedId;
            lastData = null; // Nulstil sidste data så vi får fuld opdatering
            hentValgstedsdata();

            // Fade in igen efter nyt data er hentet
            setTimeout(() => {
              fadeEl.style.opacity = "0";
            }, 100);
          }, 700);
        } else if (event.data?.action === "opdaterData") {
          // Direkte opdatering med data leveret i beskeden
          if (lastData) {
            const changes = findDataChanges(lastData, event.data.payload);
            visValgstedsdata(event.data.payload, changes, true);
          } else {
            visValgstedsdata(event.data.payload, [], false);
          }
          lastData = event.data.payload;
        } else if (event.data?.action === "genindlæs") {
          // Genindlæs hele siden
          location.reload();
        }
      });

      // Nedtællingstimer til næste opdatering
      const refreshInterval = 30; // sekunder
      let sekunderTilOpdatering = refreshInterval;

      // Opdater nedtælling hvert sekund
      setInterval(() => {
        sekunderTilOpdatering--;
        if (sekunderTilOpdatering <= 0) {
          sekunderTilOpdatering = refreshInterval;

          // Vis "opdaterer..." når tiden er ude
          el("nedtaelling").innerHTML = `
            <svg class="update-icon pulse" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z"/>
            </svg>
            Opdaterer data...
          `;
        } else {
          // Opdater normal nedtælling
          el("nedtaelling").innerHTML = `
            <svg class="update-icon ${
              sekunderTilOpdatering <= 5 ? "pulse" : ""
            }" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z"/>
            </svg>
            Opdaterer om: ${sekunderTilOpdatering} sek
          `;
        }
      }, 1000);

      // Hent nye data med jævne mellemrum
      setInterval(() => {
        // Brug subtil opdatering (true=vis loading, false=skjul loading)
        hentValgstedsdata(false);
        sekunderTilOpdatering = refreshInterval;
      }, refreshInterval * 1000);

      // Initialiser siden
      hentValgstedsdata(true);
    </script>
    <div id="fadeOverlay"></div>
  </body>
</html>
